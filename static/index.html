<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesture-Controlled Whiteboard</title>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@babel/standalone@7.22.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-800 text-white">
    <div id="root"></div>
    <script type="text/babel">
        function App() {
            const [canvasImage, setCanvasImage] = React.useState('');
            const [gesture, setGesture] = React.useState('');
            const [confidence, setConfidence] = React.useState(0);
            const [status, setStatus] = React.useState('');
            const videoRef = React.useRef(null);
            const canvasRef = React.useRef(null);

            React.useEffect(() => {
                const video = videoRef.current;
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');

                navigator.mediaDevices.getUserMedia({ video: true })
                    .then(stream => {
                        video.srcObject = stream;
                        video.play();
                    })
                    .catch(err => console.error("Error accessing webcam:", err));

                const processFrame = () => {
                    if (video.readyState === video.HAVE_ENOUGH_DATA) {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        const imageData = canvas.toDataURL('image/jpeg');
                        
                        fetch('/process_frame', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ image: imageData })
                        })
                        .then(response => response.json())
                        .then(data => {
                            setCanvasImage(data.canvas);
                            setGesture(data.gesture || '');
                            setConfidence(data.confidence);
                            setStatus(data.status);
                            if (data.filename) {
                                const link = document.createElement('a');
                                link.href = `/download/${data.filename}`;
                                link.download = data.filename;
                                link.click();
                            }
                        })
                        .catch(err => console.error("Error processing frame:", err));
                    }
                    requestAnimationFrame(processFrame);
                };

                processFrame();
                return () => {
                    if (video.srcObject) {
                        video.srcObject.getTracks().forEach(track => track.stop());
                    }
                };
            }, []);

            return (
                <div className="min-h-screen flex flex-col">
                    <header className="bg-gray-900 p-4">
                        <h1 className="text-2xl font-bold">Gesture-Controlled Whiteboard</h1>
                    </header>
                    <main className="flex-1 p-4 flex space-x-4">
                        <div className="w-1/3 bg-gray-700 p-4 rounded-lg">
                            <h2 className="text-lg font-semibold mb-2">Camera Feed</h2>
                            <video ref={videoRef} className="w-full rounded" autoPlay playsInline></video>
                            <canvas ref={canvasRef} className="hidden"></canvas>
                            <div className="mt-4">
                                <p>Current Gesture: {gesture.replace('_', ' ')} ({(confidence * 100).toFixed(1)}%)</p>
                                <p>Status: {status}</p>
                            </div>
                        </div>
                        <div className="w-2/3 bg-gray-700 p-4 rounded-lg">
                            <h2 className="text-lg font-semibold mb-2">Whiteboard</h2>
                            <img src={canvasImage} className="w-full h-[500px] object-contain" alt="Whiteboard" />
                        </div>
                        <div className="w-1/4 bg-gray-600 p-4 rounded-lg">
                            <h2 className="text-lg font-semibold mb-2">Gesture Controls</h2>
                            <ul className="space-y-2">
                                <li>Like (Thumb Up): Start Drawing</li>
                                <li>Rock (Closed Fist): Stop Drawing</li>
                                <li>Swipe (Open Hand Side-to-Side): Erase</li>
                                <li>Spread (Fingers Apart): Zoom In</li>
                                <li>Pinch (Fingers Together): Zoom Out</li>
                                <li>Two Fingers: Draw Shapes</li>
                                <li>Call (Thumb to Ear): Undo</li>
                                <li>Wave Right: Redo</li>
                                <li>Fist Twist: Change Color</li>
                                <li>OK Sign: Save Canvas</li>
                                <li>One Finger: Pan Canvas</li>
                                <li>Open Palms: Clear All</li>
                            </ul>
                        </div>
                    </main>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>